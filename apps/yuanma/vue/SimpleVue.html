<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®€æ˜“ Vue å“åº”å¼æ¡†æ¶æµ‹è¯•</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #42b983;
            text-align: center;
            margin-bottom: 10px;
            font-size: 32px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .demo-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #42b983;
        }

        .demo-section h2 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .demo-content {
            display: grid;
            gap: 15px;
        }

        .input-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .input-group label {
            min-width: 120px;
            font-weight: 600;
            color: #2c3e50;
        }

        .input-group input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #42b983;
        }

        .output {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 2px solid #e0e0e0;
            font-family: 'Courier New', monospace;
            color: #42b983;
            font-weight: bold;
        }

        button {
            padding: 10px 20px;
            background: #42b983;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #35a372;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 185, 131, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        #console {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 400px;
            overflow-y: auto;
            margin-top: 20px;
            line-height: 1.6;
        }

        #console .log {
            margin: 3px 0;
        }

        #console .log.info {
            color: #4ec9b0;
        }

        #console .log.success {
            color: #b5cea8;
        }

        #console .log.update {
            color: #ce9178;
        }

        #console .log.getter {
            color: #9cdcfe;
        }

        .clear-btn {
            background: #e74c3c;
            margin-top: 10px;
        }

        .clear-btn:hover {
            background: #c0392b;
        }

        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .feature-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #42b983;
        }

        .feature-item h3 {
            color: #42b983;
            font-size: 16px;
            margin-bottom: 8px;
        }

        .feature-item p {
            color: #666;
            font-size: 14px;
            line-height: 1.5;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ ç®€æ˜“ Vue å“åº”å¼æ¡†æ¶</h1>
        <p class="subtitle">åŸºäº Object.defineProperty å®ç°çš„å“åº”å¼ç³»ç»Ÿ</p>

        <!-- åŠŸèƒ½ç‰¹æ€§ -->
        <div class="demo-section">
            <h2>âœ¨ åŠŸèƒ½ç‰¹æ€§</h2>
            <div class="feature-list">
                <div class="feature-item">
                    <h3>ğŸ“¦ æ•°æ®åŠ«æŒ</h3>
                    <p>ä½¿ç”¨ Object.defineProperty åŠ«æŒæ•°æ®çš„ getter å’Œ setter</p>
                </div>
                <div class="feature-item">
                    <h3>ğŸ” ä¾èµ–æ”¶é›†</h3>
                    <p>è‡ªåŠ¨è¿½è¸ªæ•°æ®ä¾èµ–ï¼Œå»ºç«‹æ•°æ®ä¸è§†å›¾çš„å…³è”</p>
                </div>
                <div class="feature-item">
                    <h3>ğŸ”„ è‡ªåŠ¨æ›´æ–°</h3>
                    <p>æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨é€šçŸ¥æ‰€æœ‰ä¾èµ–è¿›è¡Œæ›´æ–°</p>
                </div>
                <div class="feature-item">
                    <h3>ğŸ‘ï¸ Watch ç›‘å¬</h3>
                    <p>æ”¯æŒ watch ç›‘å¬æ•°æ®å˜åŒ–å¹¶æ‰§è¡Œå›è°ƒ</p>
                </div>
                <div class="feature-item">
                    <h3>âš¡ è®¡ç®—å±æ€§</h3>
                    <p>æ”¯æŒ computed è®¡ç®—å±æ€§ï¼Œè‡ªåŠ¨ç¼“å­˜</p>
                </div>
                <div class="feature-item">
                    <h3>ğŸŒ³ åµŒå¥—å¯¹è±¡</h3>
                    <p>æ·±åº¦è§‚å¯ŸåµŒå¥—å¯¹è±¡çš„å±æ€§å˜åŒ–</p>
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ 1ï¼šåŸºæœ¬å“åº”å¼ -->
        <div class="demo-section">
            <h2>ğŸ“ ç¤ºä¾‹ 1ï¼šåŸºæœ¬å“åº”å¼</h2>
            <div class="demo-content">
                <div class="input-group">
                    <label>æ¶ˆæ¯ (message):</label>
                    <input type="text" id="message" value="Hello Vue!">
                </div>
                <div class="input-group">
                    <label>è®¡æ•° (count):</label>
                    <input type="number" id="count" value="0">
                </div>
                <div class="output">
                    è¾“å‡º: <span id="messageOutput">Hello Vue!</span> | è®¡æ•°: <span id="countOutput">0</span>
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ 2ï¼šè®¡ç®—å±æ€§ -->
        <div class="demo-section">
            <h2>âš¡ ç¤ºä¾‹ 2ï¼šè®¡ç®—å±æ€§</h2>
            <div class="demo-content">
                <div class="input-group">
                    <label>å§“ (lastName):</label>
                    <input type="text" id="lastName" value="å¼ ">
                </div>
                <div class="input-group">
                    <label>å (firstName):</label>
                    <input type="text" id="firstName" value="ä¸‰">
                </div>
                <div class="output">
                    å…¨å (computed): <span id="fullNameOutput">å¼ ä¸‰</span>
                </div>
            </div>
        </div>

        <!-- ç¤ºä¾‹ 3ï¼šåµŒå¥—å¯¹è±¡ -->
        <div class="demo-section">
            <h2>ğŸŒ³ ç¤ºä¾‹ 3ï¼šåµŒå¥—å¯¹è±¡å“åº”å¼</h2>
            <div class="demo-content">
                <div class="input-group">
                    <label>ç”¨æˆ·å:</label>
                    <input type="text" id="userName" value="å°æ˜">
                </div>
                <div class="input-group">
                    <label>å¹´é¾„:</label>
                    <input type="number" id="userAge" value="25">
                </div>
                <div class="output">
                    ç”¨æˆ·ä¿¡æ¯: <span id="userInfoOutput">å°æ˜ (25å²)</span>
                </div>
            </div>
        </div>

        <!-- æ§åˆ¶å°è¾“å‡º -->
        <div class="demo-section">
            <h2>ğŸ“Š æ§åˆ¶å°è¾“å‡ºï¼ˆå“åº”å¼æ—¥å¿—ï¼‰</h2>
            <div id="console"></div>
            <button class="clear-btn" onclick="clearConsole()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
    </div>

    <script type="module">
        // é‡å†™ console.logï¼Œè¾“å‡ºåˆ°é¡µé¢
        const consoleDiv = document.getElementById('console');
        const originalLog = console.log;
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            const message = args.join(' ');
            const logDiv = document.createElement('div');
            logDiv.className = 'log';
            
            // æ ¹æ®å†…å®¹æ·»åŠ ä¸åŒæ ·å¼
            if (message.includes('[Getter]')) {
                logDiv.className += ' getter';
            } else if (message.includes('[Setter]')) {
                logDiv.className += ' update';
            } else if (message.includes('âœ…')) {
                logDiv.className += ' success';
            } else {
                logDiv.className += ' info';
            }
            
            logDiv.textContent = message;
            consoleDiv.appendChild(logDiv);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        window.clearConsole = function() {
            consoleDiv.innerHTML = '';
        };
    </script>

    <script src="./SimpleVue.js" type="module"></script>
    <script type="module">
        // å¯¼å…¥éœ€è¦æ‰‹åŠ¨æ·»åŠ ï¼Œè¿™é‡Œç›´æ¥å†…è”ç®€åŒ–ç‰ˆ
        
        // ============ ç®€åŒ–çš„å“åº”å¼å®ç°ï¼ˆå†…è”ç‰ˆï¼‰ ============
        let uid = 0;

        class Dep {
            static target = null;
            constructor() {
                this.id = uid++;
                this.subs = [];
            }
            addSub(sub) {
                this.subs.push(sub);
            }
            removeSub(sub) {
                const index = this.subs.indexOf(sub);
                if (index > -1) this.subs.splice(index, 1);
            }
            depend() {
                if (Dep.target) {
                    Dep.target.addDep(this);
                }
            }
            notify() {
                const subs = this.subs.slice();
                console.log(`[Dep ${this.id}] é€šçŸ¥ ${subs.length} ä¸ªè®¢é˜…è€…`);
                subs.forEach(sub => sub.update());
            }
        }

        const targetStack = [];
        function pushTarget(target) {
            targetStack.push(target);
            Dep.target = target;
        }
        function popTarget() {
            targetStack.pop();
            Dep.target = targetStack[targetStack.length - 1];
        }

        function observe(value) {
            if (!value || typeof value !== 'object') return;
            return new Observer(value);
        }

        class Observer {
            constructor(value) {
                this.value = value;
                this.dep = new Dep();
                Object.defineProperty(value, '__ob__', {
                    value: this,
                    enumerable: false,
                    writable: true,
                    configurable: true
                });
                this.walk(value);
            }
            walk(obj) {
                Object.keys(obj).forEach(key => defineReactive(obj, key));
            }
        }

        function defineReactive(obj, key, val) {
            const dep = new Dep();
            if (arguments.length === 2) {
                val = obj[key];
            }
            let childOb = observe(val);

            Object.defineProperty(obj, key, {
                enumerable: true,
                configurable: true,
                get() {
                    if (Dep.target) {
                        console.log(`[Getter] ${key} æ”¶é›†ä¾èµ–`);
                        dep.depend();
                        if (childOb) childOb.dep.depend();
                    }
                    return val;
                },
                set(newVal) {
                    if (newVal === val) return;
                    console.log(`[Setter] ${key}: ${val} -> ${newVal}`);
                    val = newVal;
                    childOb = observe(newVal);
                    dep.notify();
                }
            });
        }

        class Watcher {
            constructor(vm, expOrFn, cb) {
                this.vm = vm;
                this.id = uid++;
                this.cb = cb;
                this.deps = [];
                this.depIds = new Set();
                this.newDeps = [];
                this.newDepIds = new Set();
                debugger
                if (typeof expOrFn === 'function') {
                    this.getter = expOrFn;
                } else {
                    this.getter = function() {
                        const segments = expOrFn.split('.');
                        let obj = vm;
                        for (let i = 0; i < segments.length; i++) {
                            if (!obj) return;
                            obj = obj[segments[i]];
                        }
                        return obj;
                    };
                }
                
                this.value = this.get();
            }
            
            get() {
                pushTarget(this);
                let value;
                try {
                    value = this.getter.call(this.vm, this.vm);
                } finally {
                    popTarget();
                    this.cleanupDeps();
                }
                return value;
            }
            
            addDep(dep) {
                const id = dep.id;
                if (!this.newDepIds.has(id)) {
                    this.newDepIds.add(id);
                    this.newDeps.push(dep);
                    if (!this.depIds.has(id)) {
                        dep.addSub(this);
                    }
                }
            }
            
            cleanupDeps() {
                let i = this.deps.length;
                while (i--) {
                    const dep = this.deps[i];
                    if (!this.newDepIds.has(dep.id)) {
                        dep.removeSub(this);
                    }
                }
                let tmp = this.depIds;
                this.depIds = this.newDepIds;
                this.newDepIds = tmp;
                this.newDepIds.clear();
                tmp = this.deps;
                this.deps = this.newDeps;
                this.newDeps = tmp;
                this.newDeps.length = 0;
            }
            
            update() {
                console.log(`[Watcher-${this.id}] è§¦å‘æ›´æ–°`);
                this.run();
            }
            
            run() {
                const value = this.get();
                if (value !== this.value || typeof value === 'object') {
                    const oldValue = this.value;
                    this.value = value;
                    this.cb.call(this.vm, value, oldValue);
                }
            }
        }

        // ============ åˆ›å»º Vue å®ä¾‹ ============
        
        // ç¤ºä¾‹ 1ï¼šåŸºæœ¬å“åº”å¼
        const data1 = { message: 'Hello Vue!', count: 0 };
        observe(data1);
        console.log(data1, 'data1');
        
        new Watcher(data1, 'message', (newVal) => {
            document.getElementById('messageOutput').textContent = newVal;
            console.log(`âœ… message æ›´æ–°ä¸º: ${newVal}`);
        });
        
        new Watcher(data1, 'count', (newVal) => {
            document.getElementById('countOutput').textContent = newVal;
            console.log(`âœ… count æ›´æ–°ä¸º: ${newVal}`);
        });
        
        document.getElementById('message').addEventListener('input', (e) => {
            data1.message = e.target.value;
        });
        
        document.getElementById('count').addEventListener('input', (e) => {
            data1.count = Number(e.target.value);
        });

        // ç¤ºä¾‹ 2ï¼šè®¡ç®—å±æ€§
        const data2 = { firstName: 'ä¸‰', lastName: 'å¼ ' };
        observe(data2);
        
        const updateFullName = () => {
            const fullName = data2.lastName + data2.firstName;
            document.getElementById('fullNameOutput').textContent = fullName;
            console.log(`âœ… è®¡ç®—å±æ€§ fullName: ${fullName}`);
        };
        
        new Watcher(data2, () => data2.lastName + data2.firstName, updateFullName);
        
        document.getElementById('firstName').addEventListener('input', (e) => {
            data2.firstName = e.target.value;
        });
        
        document.getElementById('lastName').addEventListener('input', (e) => {
            data2.lastName = e.target.value;
        });

        // ç¤ºä¾‹ 3ï¼šåµŒå¥—å¯¹è±¡
        const data3 = { 
            user: { 
                name: 'å°æ˜', 
                age: 25 
            } 
        };
        observe(data3);
        
        const updateUserInfo = () => {
            const info = `${data3.user.name} (${data3.user.age}å²)`;
            document.getElementById('userInfoOutput').textContent = info;
            console.log(`âœ… ç”¨æˆ·ä¿¡æ¯æ›´æ–°: ${info}`);
        };
        
        new Watcher(data3, () => data3.user.name + data3.user.age, updateUserInfo);
        
        document.getElementById('userName').addEventListener('input', (e) => {
            data3.user.name = e.target.value;
        });
        
        document.getElementById('userAge').addEventListener('input', (e) => {
            data3.user.age = Number(e.target.value);
        });

        console.log('ğŸ‰ ç®€æ˜“ Vue å“åº”å¼æ¡†æ¶åˆå§‹åŒ–å®Œæˆï¼');
        console.log('ğŸ‘‰ è¯·åœ¨ä¸Šæ–¹è¾“å…¥æ¡†ä¸­ä¿®æ”¹æ•°æ®ï¼Œè§‚å¯Ÿå“åº”å¼æ•ˆæœ');
    </script>
</body>
</html>

