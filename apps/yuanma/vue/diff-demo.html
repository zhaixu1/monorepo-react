<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vue2 Diffç®—æ³•å¯è§†åŒ–æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .btn.active {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
        }

        .demo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .tree-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .tree-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
        }

        .tree-title.old {
            color: #dc3545;
        }

        .tree-title.new {
            color: #28a745;
        }

        .vnode-tree {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-height: 200px;
            overflow-x: auto;
        }

        .vnode {
            margin: 5px 0;
            padding: 8px;
            border-radius: 5px;
            border-left: 4px solid #007bff;
            background: #f8f9fa;
        }

        .vnode.element {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .vnode.text {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .vnode.key {
            font-weight: bold;
            color: #007bff;
        }

        .diff-process {
            grid-column: 1 / -1;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .diff-title {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #495057;
            text-align: center;
        }

        .diff-steps {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .diff-step {
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            animation: slideIn 0.5s ease-out;
        }

        .diff-step.create {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .diff-step.update {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .diff-step.remove {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .diff-step.move {
            border-left-color: #6f42c1;
            background: #e2d9f3;
        }

        .step-title {
            font-weight: bold;
            margin-bottom: 5px;
        }

        .step-description {
            font-size: 14px;
            color: #6c757d;
        }

        .algorithm-explanation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-top: 30px;
        }

        .algorithm-explanation h3 {
            margin-bottom: 15px;
            font-size: 1.4em;
        }

        .algorithm-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .algorithm-step {
            background: rgba(255,255,255,0.1);
            padding: 15px;
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }

        .algorithm-step h4 {
            margin-bottom: 10px;
            color: #ffd700;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .highlight {
            background: #ffeb3b !important;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { background: #ffeb3b; }
            50% { background: #ffc107; }
            100% { background: #ffeb3b; }
        }

        .stats {
            display: flex;
            justify-content: space-around;
            margin: 20px 0;
            padding: 20px;
            background: #e9ecef;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #007bff;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        /* ä»£ç å±•ç¤ºåŒºåŸŸæ ·å¼ */
        .code-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-top: 30px;
            border: 2px solid #e9ecef;
        }

        .code-section h3 {
            color: #495057;
            margin-bottom: 20px;
            font-size: 1.4em;
        }

        .code-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .code-tab {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: #e9ecef;
            color: #495057;
        }

        .code-tab:hover {
            background: #dee2e6;
            transform: translateY(-1px);
        }

        .code-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .code-content {
            background: white;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .code-content h4 {
            color: #495057;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .code-explanation {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196f3;
        }

        .code-explanation p {
            margin: 0;
            color: #1565c0;
            font-size: 14px;
            line-height: 1.5;
        }

        pre {
            background: #2d3748;
            color: #e2e8f0;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            margin: 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        code {
            font-family: 'Courier New', monospace;
        }

        pre code {
            color: inherit;
            background: none;
            padding: 0;
        }

        /* ä»£ç é«˜äº® */
        .javascript {
            color: #e2e8f0;
        }

        /* æ³¨é‡Šæ ·å¼ */
        pre code .comment {
            color: #68d391;
            font-style: italic;
        }

        /* å…³é”®å­—æ ·å¼ */
        pre code .keyword {
            color: #f687b3;
            font-weight: bold;
        }

        /* å­—ç¬¦ä¸²æ ·å¼ */
        pre code .string {
            color: #fbb6ce;
        }

        /* æ•°å­—æ ·å¼ */
        pre code .number {
            color: #f6ad55;
        }

        @media (max-width: 768px) {
            .demo-section {
                grid-template-columns: 1fr;
            }
            
            .controls {
                justify-content: center;
            }
            
            .algorithm-steps {
                grid-template-columns: 1fr;
            }

            .code-tabs {
                justify-content: center;
            }

            pre {
                font-size: 11px;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Vue2 Diffç®—æ³•å¯è§†åŒ–æ¼”ç¤º</h1>
            <p>æ·±å…¥ç†è§£è™šæ‹ŸDOMçš„diffç®—æ³•å·¥ä½œåŸç†</p>
        </div>

        <div class="content">
            <div class="controls">
                <button class="btn" onclick="runDemo('basic')">åŸºç¡€æ¯”è¾ƒ</button>
                <button class="btn" onclick="runDemo('reorder')">èŠ‚ç‚¹é‡æ’</button>
                <button class="btn" onclick="runDemo('addRemove')">å¢åˆ èŠ‚ç‚¹</button>
                <button class="btn" onclick="runDemo('complex')">å¤æ‚åœºæ™¯</button>
                <button class="btn" onclick="clearDemo()">æ¸…ç©ºæ¼”ç¤º</button>
            </div>

            <div class="stats" id="stats">
                <div class="stat-item">
                    <div class="stat-number" id="createCount">0</div>
                    <div class="stat-label">åˆ›å»ºèŠ‚ç‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="updateCount">0</div>
                    <div class="stat-label">æ›´æ–°èŠ‚ç‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="removeCount">0</div>
                    <div class="stat-label">åˆ é™¤èŠ‚ç‚¹</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="moveCount">0</div>
                    <div class="stat-label">ç§»åŠ¨èŠ‚ç‚¹</div>
                </div>
            </div>

            <div class="demo-section">
                <div class="tree-container">
                    <div class="tree-title old">æ—§è™šæ‹ŸDOMæ ‘</div>
                    <div class="vnode-tree" id="oldTree"></div>
                </div>
                <div class="tree-container">
                    <div class="tree-title new">æ–°è™šæ‹ŸDOMæ ‘</div>
                    <div class="vnode-tree" id="newTree"></div>
                </div>
            </div>

            <div class="diff-process">
                <div class="diff-title">Diffç®—æ³•æ‰§è¡Œè¿‡ç¨‹</div>
                <div class="diff-steps" id="diffSteps"></div>
            </div>

            <div class="algorithm-explanation">
                <h3>ğŸ§  Vue2 Diffç®—æ³•æ ¸å¿ƒåŸç†</h3>
                <div class="algorithm-steps">
                    <div class="algorithm-step">
                        <h4>1. åŒå±‚æ¯”è¾ƒ</h4>
                        <p>åªæ¯”è¾ƒåŒä¸€å±‚çº§çš„èŠ‚ç‚¹ï¼Œä¸ä¼šè·¨å±‚çº§æ¯”è¾ƒï¼Œå¤§å¤§æé«˜äº†æ¯”è¾ƒæ•ˆç‡ã€‚</p>
                    </div>
                    <div class="algorithm-step">
                        <h4>2. åŒç«¯æ¯”è¾ƒ</h4>
                        <p>é‡‡ç”¨å¤´å¤´ã€å°¾å°¾ã€å¤´å°¾ã€å°¾å¤´å››ç§æ¯”è¾ƒæ–¹å¼ï¼Œæœ€å¤§åŒ–å¤ç”¨ç°æœ‰èŠ‚ç‚¹ã€‚</p>
                    </div>
                    <div class="algorithm-step">
                        <h4>3. Keyä¼˜åŒ–</h4>
                        <p>ä½¿ç”¨keyå€¼è¿›è¡ŒèŠ‚ç‚¹è¯†åˆ«ï¼Œé¿å…ä¸å¿…è¦çš„DOMæ“ä½œï¼Œæå‡æ€§èƒ½ã€‚</p>
                    </div>
                    <div class="algorithm-step">
                        <h4>4. æœ€å°åŒ–æ“ä½œ</h4>
                        <p>å°½å¯èƒ½å¤ç”¨ç°æœ‰DOMèŠ‚ç‚¹ï¼Œåªå¯¹çœŸæ­£å˜åŒ–çš„éƒ¨åˆ†è¿›è¡Œæ›´æ–°ã€‚</p>
                    </div>
                </div>
            </div>

            <!-- æ ¸å¿ƒç®—æ³•ä»£ç å±•ç¤º -->
            <div class="code-section">
                <h3>ğŸ’» æ ¸å¿ƒç®—æ³•å®ç°</h3>
                
                <!-- ç®—æ³•é€‰æ‹©å™¨ -->
                <div class="code-tabs">
                    <button class="code-tab active" onclick="showAlgorithm('sameVnode')">èŠ‚ç‚¹æ¯”è¾ƒ</button>
                    <button class="code-tab" onclick="showAlgorithm('updateChildren')">å­èŠ‚ç‚¹Diff</button>
                    <button class="code-tab" onclick="showAlgorithm('patchVnode')">èŠ‚ç‚¹æ›´æ–°</button>
                    <button class="code-tab" onclick="showAlgorithm('patch')">ä¸»Patchå‡½æ•°</button>
                </div>

                <!-- èŠ‚ç‚¹æ¯”è¾ƒç®—æ³• -->
                <div class="code-content" id="sameVnode-code">
                    <h4>ğŸ” sameVnode - åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒèŠ‚ç‚¹</h4>
                    <div class="code-explanation">
                        <p>è¿™æ˜¯diffç®—æ³•çš„ç¬¬ä¸€æ­¥ï¼Œç”¨äºåˆ¤æ–­ä¸¤ä¸ªè™šæ‹ŸèŠ‚ç‚¹æ˜¯å¦ä¸ºåŒä¸€ä¸ªèŠ‚ç‚¹ã€‚åªæœ‰ç›¸åŒèŠ‚ç‚¹æ‰ä¼šè¿›è¡Œè¿›ä¸€æ­¥çš„æ¯”è¾ƒå’Œæ›´æ–°ã€‚</p>
                    </div>
                    <pre><code class="javascript">function sameVnode(a, b) {
  return (
    a.key === b.key &&           // keyå€¼ç›¸åŒ
    a.tag === b.tag &&           // æ ‡ç­¾åç›¸åŒ
    a.isComment === b.isComment && // æ³¨é‡Šç±»å‹ç›¸åŒ
    isDef(a.data) === isDef(b.data) && // æ•°æ®å±æ€§å­˜åœ¨æ€§ç›¸åŒ
    sameInputType(a, b)          // è¾“å…¥ç±»å‹ç›¸åŒï¼ˆé’ˆå¯¹inputå…ƒç´ ï¼‰
  );
}

// åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒè¾“å…¥ç±»å‹
function sameInputType(a, b) {
  if (a.tag !== 'input') return true;
  let i;
  const typeA = isDef(i = a.data) && isDef(i = i.attrs) && i.type;
  const typeB = isDef(i = b.data) && isDef(i = i.attrs) && i.type;
  return typeA === typeB || (isTextInputType(typeA) && isTextInputType(typeB));
}</code></pre>
                </div>

                <!-- å­èŠ‚ç‚¹Diffç®—æ³• -->
                <div class="code-content" id="updateChildren-code" style="display: none;">
                    <h4>ğŸ”„ updateChildren - å­èŠ‚ç‚¹Diffç®—æ³•ï¼ˆæ ¸å¿ƒï¼‰</h4>
                    <div class="code-explanation">
                        <p>è¿™æ˜¯Vue2 diffç®—æ³•æœ€æ ¸å¿ƒçš„éƒ¨åˆ†ï¼Œé‡‡ç”¨åŒç«¯æ¯”è¾ƒç­–ç•¥ï¼Œé€šè¿‡å››ä¸ªæŒ‡é’ˆï¼ˆoldStartIdx, oldEndIdx, newStartIdx, newEndIdxï¼‰è¿›è¡Œé«˜æ•ˆæ¯”è¾ƒã€‚</p>
                    </div>
                    <pre><code class="javascript">function updateChildren(parentElm, oldCh, newCh, insertedVnodeQueue, removeOnly) {
  let oldStartIdx = 0;           // æ—§èŠ‚ç‚¹å¼€å§‹ç´¢å¼•
  let newStartIdx = 0;           // æ–°èŠ‚ç‚¹å¼€å§‹ç´¢å¼•
  let oldEndIdx = oldCh.length - 1;  // æ—§èŠ‚ç‚¹ç»“æŸç´¢å¼•
  let oldStartVnode = oldCh[0];   // æ—§èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹
  let oldEndVnode = oldCh[oldEndIdx]; // æ—§èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹
  let newEndIdx = newCh.length - 1;  // æ–°èŠ‚ç‚¹ç»“æŸç´¢å¼•
  let newStartVnode = newCh[0];   // æ–°èŠ‚ç‚¹å¼€å§‹èŠ‚ç‚¹
  let newEndVnode = newCh[newEndIdx]; // æ–°èŠ‚ç‚¹ç»“æŸèŠ‚ç‚¹
  let oldKeyToIdx, idxInOld, vnodeToMove, refElm;

  const canMove = !removeOnly;

  // åŒç«¯æ¯”è¾ƒå¾ªç¯
  while (oldStartIdx <= oldEndIdx && newStartIdx <= newEndIdx) {
    if (isUndef(oldStartVnode)) {
      oldStartVnode = oldCh[++oldStartIdx]; // è·³è¿‡å·²å¤„ç†çš„èŠ‚ç‚¹
    } else if (isUndef(oldEndVnode)) {
      oldEndVnode = oldCh[--oldEndIdx];
    } else if (sameVnode(oldStartVnode, newStartVnode)) {
      // å¤´å¤´æ¯”è¾ƒ - æœ€ç†æƒ³çš„æƒ…å†µ
      patchVnode(oldStartVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
      oldStartVnode = oldCh[++oldStartIdx];
      newStartVnode = newCh[++newStartIdx];
    } else if (sameVnode(oldEndVnode, newEndVnode)) {
      // å°¾å°¾æ¯”è¾ƒ - ä¹Ÿå¾ˆç†æƒ³
      patchVnode(oldEndVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);
      oldEndVnode = oldCh[--oldEndIdx];
      newEndVnode = newCh[--newEndIdx];
    } else if (sameVnode(oldStartVnode, newEndVnode)) {
      // å¤´å°¾æ¯”è¾ƒ - éœ€è¦ç§»åŠ¨èŠ‚ç‚¹
      patchVnode(oldStartVnode, newEndVnode, insertedVnodeQueue, newCh, newEndIdx);
      canMove && nodeOps.insertBefore(parentElm, oldStartVnode.elm, nodeOps.nextSibling(oldEndVnode.elm));
      oldStartVnode = oldCh[++oldStartIdx];
      newEndVnode = newCh[--newEndIdx];
    } else if (sameVnode(oldEndVnode, newStartVnode)) {
      // å°¾å¤´æ¯”è¾ƒ - éœ€è¦ç§»åŠ¨èŠ‚ç‚¹
      patchVnode(oldEndVnode, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
      canMove && nodeOps.insertBefore(parentElm, oldEndVnode.elm, oldStartVnode.elm);
      oldEndVnode = oldCh[--oldEndIdx];
      newStartVnode = newCh[++newStartIdx];
    } else {
      // å»ºç«‹keyåˆ°ç´¢å¼•çš„æ˜ å°„ï¼Œè¿›è¡Œkeyæ¯”è¾ƒ
      if (isUndef(oldKeyToIdx)) {
        oldKeyToIdx = createKeyToOldIdx(oldCh, oldStartIdx, oldEndIdx);
      }
      idxInOld = isDef(newStartVnode.key)
        ? oldKeyToIdx[newStartVnode.key]
        : findIdxInOld(newStartVnode, oldCh, oldStartIdx, oldEndIdx);
      if (isUndef(idxInOld)) {
        // æ–°èŠ‚ç‚¹ - åˆ›å»ºDOMå…ƒç´ 
        createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx);
      } else {
        // ç§»åŠ¨èŠ‚ç‚¹
        vnodeToMove = oldCh[idxInOld];
        if (sameVnode(vnodeToMove, newStartVnode)) {
          patchVnode(vnodeToMove, newStartVnode, insertedVnodeQueue, newCh, newStartIdx);
          oldCh[idxInOld] = undefined;
          canMove && nodeOps.insertBefore(parentElm, vnodeToMove.elm, oldStartVnode.elm);
        } else {
          // ç›¸åŒkeyä½†ä¸åŒèŠ‚ç‚¹ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
          createElm(newStartVnode, insertedVnodeQueue, parentElm, oldStartVnode.elm, false, newCh, newStartIdx);
        }
      }
      newStartVnode = newCh[++newStartIdx];
    }
  }
  
  // å¤„ç†å‰©ä½™èŠ‚ç‚¹
  if (oldStartIdx > oldEndIdx) {
    // æ–°å¢èŠ‚ç‚¹
    refElm = isUndef(newCh[newEndIdx + 1]) ? null : newCh[newEndIdx + 1].elm;
    addVnodes(parentElm, refElm, newCh, newStartIdx, newEndIdx, insertedVnodeQueue);
  } else if (newStartIdx > newEndIdx) {
    // åˆ é™¤èŠ‚ç‚¹
    removeVnodes(parentElm, oldCh, oldStartIdx, oldEndIdx);
  }
}</code></pre>
                </div>

                <!-- èŠ‚ç‚¹æ›´æ–°ç®—æ³• -->
                <div class="code-content" id="patchVnode-code" style="display: none;">
                    <h4>ğŸ”§ patchVnode - èŠ‚ç‚¹æ›´æ–°ç®—æ³•</h4>
                    <div class="code-explanation">
                        <p>è´Ÿè´£æ¯”è¾ƒå’Œæ›´æ–°å•ä¸ªè™šæ‹ŸèŠ‚ç‚¹çš„å±æ€§ã€å­èŠ‚ç‚¹å’Œæ–‡æœ¬å†…å®¹ï¼Œæ˜¯diffç®—æ³•çš„æ ¸å¿ƒæ¯”è¾ƒé€»è¾‘ã€‚</p>
                    </div>
                    <pre><code class="javascript">function patchVnode(oldVnode, vnode, insertedVnodeQueue, ownerArray, index, removeOnly) {
  // 1. å¦‚æœæ˜¯åŒä¸€ä¸ªå¯¹è±¡ï¼Œç›´æ¥è¿”å›
  if (oldVnode === vnode) {
    return;
  }

  // 2. å…‹éš†èŠ‚ç‚¹ï¼ˆå¦‚æœéœ€è¦ï¼‰
  if (isDef(vnode.elm) && isDef(ownerArray)) {
    vnode = ownerArray[index] = cloneVNode(vnode);
  }

  // 3. è·å–çœŸå®DOMå…ƒç´ 
  const elm = vnode.elm = oldVnode.elm;

  // 4. å¤„ç†å¼‚æ­¥å ä½ç¬¦
  if (isTrue(oldVnode.isAsyncPlaceholder)) {
    if (isDef(vnode.asyncFactory.resolved)) {
      hydrate(oldVnode.elm, vnode, insertedVnodeQueue);
    } else {
      vnode.isAsyncPlaceholder = true;
    }
    return;
  }

  // 5. é™æ€èŠ‚ç‚¹å¤ç”¨ä¼˜åŒ–
  if (isTrue(vnode.isStatic) &&
    isTrue(oldVnode.isStatic) &&
    vnode.key === oldVnode.key &&
    (isTrue(vnode.isCloned) || isTrue(vnode.isOnce))
  ) {
    vnode.componentInstance = oldVnode.componentInstance;
    return;
  }

  // 6. æ‰§è¡Œprepatché’©å­
  let i;
  const data = vnode.data;
  if (isDef(data) && isDef(i = data.hook) && isDef(i = i.prepatch)) {
    i(oldVnode, vnode);
  }

  // 7. æ›´æ–°èŠ‚ç‚¹å±æ€§
  const oldCh = oldVnode.children;
  const ch = vnode.children;
  if (isDef(data) && isPatchable(vnode)) {
    // æ‰§è¡Œå…¨å±€updateé’©å­
    for (i = 0; i < cbs.update.length; ++i) {
      cbs.update[i](oldVnode, vnode);
    }
    // æ‰§è¡Œç”¨æˆ·è‡ªå®šä¹‰updateé’©å­
    if (isDef(i = data.hook) && isDef(i = i.update)) {
      i(oldVnode, vnode);
    }
  }

  // 8. å¤„ç†å­èŠ‚ç‚¹
  if (isUndef(vnode.text)) {
    if (isDef(oldCh) && isDef(ch)) {
      if (oldCh !== ch) {
        // é€’å½’æ¯”è¾ƒå­èŠ‚ç‚¹
        updateChildren(elm, oldCh, ch, insertedVnodeQueue, removeOnly);
      }
    } else if (isDef(ch)) {
      // åªæœ‰æ–°å­èŠ‚ç‚¹ï¼Œæ‰¹é‡æ·»åŠ 
      if (process.env.NODE_ENV !== 'production') {
        checkDuplicateKeys(ch);
      }
      if (isDef(oldVnode.text)) {
        nodeOps.setTextContent(elm, '');
      }
      addVnodes(elm, null, ch, 0, ch.length - 1, insertedVnodeQueue);
    } else if (isDef(oldCh)) {
      // åªæœ‰æ—§å­èŠ‚ç‚¹ï¼Œæ‰¹é‡åˆ é™¤
      removeVnodes(elm, oldCh, 0, oldCh.length - 1);
    } else if (isDef(oldVnode.text)) {
      // æ¸…ç©ºæ–‡æœ¬
      nodeOps.setTextContent(elm, '');
    }
  } else if (oldVnode.text !== vnode.text) {
    // 9. æ›´æ–°æ–‡æœ¬å†…å®¹
    nodeOps.setTextContent(elm, vnode.text);
  }

  // 10. æ‰§è¡Œpostpatché’©å­
  if (isDef(data)) {
    if (isDef(i = data.hook) && isDef(i = i.postpatch)) {
      i(oldVnode, vnode);
    }
  }
}</code></pre>
                </div>

                <!-- ä¸»Patchå‡½æ•° -->
                <div class="code-content" id="patch-code" style="display: none;">
                    <h4>ğŸš€ patch - ä¸»Patchå‡½æ•°</h4>
                    <div class="code-explanation">
                        <p>diffç®—æ³•çš„å…¥å£å‡½æ•°ï¼Œè´Ÿè´£åè°ƒæ•´ä¸ªdiffè¿‡ç¨‹ï¼Œå†³å®šæ˜¯åˆ›å»ºæ–°èŠ‚ç‚¹è¿˜æ˜¯æ›´æ–°ç°æœ‰èŠ‚ç‚¹ã€‚</p>
                    </div>
                    <pre><code class="javascript">function patch(oldVnode, vnode, hydrating, removeOnly) {
  // 1. å¦‚æœæ–°èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œé”€æ¯æ—§èŠ‚ç‚¹
  if (isUndef(vnode)) {
    if (isDef(oldVnode)) {
      invokeDestroyHook(oldVnode);
    }
    return;
  }

  let isInitialPatch = false;
  const insertedVnodeQueue = [];

  // 2. å¦‚æœæ—§èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°èŠ‚ç‚¹
  if (isUndef(oldVnode)) {
    isInitialPatch = true;
    createElm(vnode, insertedVnodeQueue);
  } else {
    const isRealElement = isDef(oldVnode.nodeType);
    
    // 3. åˆ¤æ–­æ˜¯å¦ä¸ºç›¸åŒèŠ‚ç‚¹
    if (!isRealElement && sameVnode(oldVnode, vnode)) {
      // ç›¸åŒèŠ‚ç‚¹ï¼Œè¿›è¡Œpatch
      patchVnode(oldVnode, vnode, insertedVnodeQueue, null, null, removeOnly);
    } else {
      // 4. ä¸åŒèŠ‚ç‚¹ï¼Œéœ€è¦æ›¿æ¢
      if (isRealElement) {
        // å¦‚æœæ˜¯çœŸå®DOMå…ƒç´ ï¼Œåˆ›å»ºè™šæ‹ŸèŠ‚ç‚¹
        oldVnode = emptyNodeAt(oldVnode);
      }

      // 5. åˆ›å»ºæ–°èŠ‚ç‚¹
      const oldElm = oldVnode.elm;
      const parentElm = nodeOps.parentNode(oldElm);

      createElm(
        vnode,
        insertedVnodeQueue,
        oldElm._leaveCb ? null : parentElm,
        nodeOps.nextSibling(oldElm)
      );

      // 6. æ›´æ–°çˆ¶èŠ‚ç‚¹å¼•ç”¨
      if (isDef(vnode.parent)) {
        let ancestor = vnode.parent;
        const patchable = isPatchable(vnode);
        while (ancestor) {
          for (let i = 0; i < cbs.destroy.length; ++i) {
            cbs.destroy[i](ancestor);
          }
          ancestor.elm = vnode.elm;
          if (patchable) {
            for (let i = 0; i < cbs.create.length; ++i) {
              cbs.create[i](emptyNode, ancestor);
            }
            const insert = ancestor.data.hook.insert;
            if (insert.merged) {
              for (let i = 1; i < insert.fns.length; i++) {
                insert.fns[i]();
              }
            } else {
              insert();
            }
          } else {
            registerRef(ancestor);
          }
          ancestor = ancestor.parent;
        }
      }

      // 7. ç§»é™¤æ—§èŠ‚ç‚¹
      if (isDef(parentElm)) {
        removeVnodes(parentElm, [oldVnode], 0, 0);
      } else if (isDef(oldVnode.tag)) {
        invokeDestroyHook(oldVnode);
      }
    }
  }

  // 8. æ‰§è¡Œæ’å…¥é’©å­
  invokeInsertHook(vnode, insertedVnodeQueue, isInitialPatch);
  return vnode.elm;
}</code></pre>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Vue2 Diffç®—æ³•æ ¸å¿ƒå®ç°
        class VNode {
            constructor(tag, data, children, text, elm) {
                this.tag = tag;
                this.data = data;
                this.children = children;
                this.text = text;
                this.elm = elm;
                this.key = data && data.key;
            }
        }

        function createTextVNode(text) {
            return new VNode(undefined, undefined, undefined, text);
        }

        function createElementVNode(tag, data, children) {
            return new VNode(tag, data, children);
        }

        function sameVnode(a, b) {
            return (
                a.key === b.key &&
                a.tag === b.tag &&
                a.isComment === b.isComment &&
                isDef(a.data) === isDef(b.data) &&
                sameInputType(a, b)
            );
        }

        function sameInputType(a, b) {
            if (a.tag !== 'input') return true;
            let i;
            const typeA = isDef(i = a.data) && isDef(i = i.attrs) && i.type;
            const typeB = isDef(i = b.data) && isDef(i = i.attrs) && i.type;
            return typeA === typeB || (isTextInputType(typeA) && isTextInputType(typeB));
        }

        function isTextInputType(type) {
            return ['text', 'number', 'password', 'search', 'email', 'tel', 'url'].indexOf(type) > -1;
        }

        function isDef(v) {
            return v !== undefined && v !== null;
        }

        function isUndef(v) {
            return v === undefined || v === null;
        }

        // å¯è§†åŒ–æ¸²æŸ“å‡½æ•°
        function renderVNodeTree(vnode, container) {
            container.innerHTML = '';
            if (!vnode) return;
            
            function renderNode(node, depth = 0) {
                const indent = '  '.repeat(depth);
                const div = document.createElement('div');
                div.className = 'vnode';
                
                if (node.tag) {
                    div.className += ' element';
                    div.innerHTML = `${indent}&lt;${node.tag}${node.key ? ` key="${node.key}"` : ''}&gt;`;
                    container.appendChild(div);
                    
                    if (node.children) {
                        node.children.forEach(child => {
                            renderNode(child, depth + 1);
                        });
                    }
                    
                    const closeDiv = document.createElement('div');
                    closeDiv.className = 'vnode element';
                    closeDiv.innerHTML = `${indent}&lt;/${node.tag}&gt;`;
                    container.appendChild(closeDiv);
                } else {
                    div.className += ' text';
                    div.innerHTML = `${indent}"${node.text}"`;
                    container.appendChild(div);
                }
            }
            
            renderNode(vnode);
        }

        // Diffç®—æ³•å¯è§†åŒ–
        function visualizeDiff(oldVnode, newVnode) {
            const diffSteps = document.getElementById('diffSteps');
            diffSteps.innerHTML = '';
            
            const stats = {
                create: 0,
                update: 0,
                remove: 0,
                move: 0
            };
            
            let stepIndex = 0;
            
            function addStep(type, title, description) {
                setTimeout(() => {
                    const step = document.createElement('div');
                    step.className = `diff-step ${type}`;
                    step.innerHTML = `
                        <div class="step-title">${title}</div>
                        <div class="step-description">${description}</div>
                    `;
                    diffSteps.appendChild(step);
                    step.scrollIntoView({ behavior: 'smooth' });
                }, stepIndex * 500);
                stepIndex++;
                stats[type]++;
            }
            
            // æ¨¡æ‹Ÿdiffè¿‡ç¨‹
            if (oldVnode && newVnode) {
                if (sameVnode(oldVnode, newVnode)) {
                    addStep('update', 'èŠ‚ç‚¹æ¯”è¾ƒ', 'å‘ç°ç›¸åŒèŠ‚ç‚¹ï¼Œè¿›è¡Œå±æ€§æ›´æ–°');
                    
                    if (oldVnode.children && newVnode.children) {
                        addStep('update', 'å­èŠ‚ç‚¹æ¯”è¾ƒ', 'å¼€å§‹æ¯”è¾ƒå­èŠ‚ç‚¹åˆ—è¡¨');
                        compareChildren(oldVnode.children, newVnode.children, addStep);
                    }
                } else {
                    addStep('remove', 'èŠ‚ç‚¹æ›¿æ¢', 'èŠ‚ç‚¹ç±»å‹ä¸åŒï¼Œç§»é™¤æ—§èŠ‚ç‚¹');
                    addStep('create', 'åˆ›å»ºæ–°èŠ‚ç‚¹', 'åˆ›å»ºæ–°çš„DOMèŠ‚ç‚¹');
                }
            }
            
            // æ›´æ–°ç»Ÿè®¡
            setTimeout(() => {
                document.getElementById('createCount').textContent = stats.create;
                document.getElementById('updateCount').textContent = stats.update;
                document.getElementById('removeCount').textContent = stats.remove;
                document.getElementById('moveCount').textContent = stats.move;
            }, stepIndex * 500);
        }
        
        function compareChildren(oldChildren, newChildren, addStep) {
            // ç®€åŒ–çš„å­èŠ‚ç‚¹æ¯”è¾ƒé€»è¾‘
            const oldKeys = oldChildren.map(child => child.key).filter(Boolean);
            const newKeys = newChildren.map(child => child.key).filter(Boolean);
            
            // æ£€æŸ¥æ–°å¢çš„èŠ‚ç‚¹
            newKeys.forEach(key => {
                if (!oldKeys.includes(key)) {
                    addStep('create', `åˆ›å»ºèŠ‚ç‚¹ (key: ${key})`, 'å‘ç°æ–°èŠ‚ç‚¹ï¼Œéœ€è¦åˆ›å»ºDOMå…ƒç´ ');
                }
            });
            
            // æ£€æŸ¥åˆ é™¤çš„èŠ‚ç‚¹
            oldKeys.forEach(key => {
                if (!newKeys.includes(key)) {
                    addStep('remove', `åˆ é™¤èŠ‚ç‚¹ (key: ${key})`, 'èŠ‚ç‚¹ä¸å†éœ€è¦ï¼Œç§»é™¤DOMå…ƒç´ ');
                }
            });
            
            // æ£€æŸ¥ç§»åŠ¨çš„èŠ‚ç‚¹
            const movedKeys = [];
            newKeys.forEach((key, newIndex) => {
                const oldIndex = oldKeys.indexOf(key);
                if (oldIndex !== -1 && oldIndex !== newIndex) {
                    movedKeys.push(key);
                }
            });
            
            if (movedKeys.length > 0) {
                addStep('move', `ç§»åŠ¨èŠ‚ç‚¹ (${movedKeys.join(', ')})`, 'èŠ‚ç‚¹ä½ç½®å‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦ç§»åŠ¨DOMå…ƒç´ ');
            }
        }

        // æ¼”ç¤ºåœºæ™¯
        const demos = {
            basic: {
                old: createElementVNode('div', { id: 'app' }, [
                    createElementVNode('h1', { key: 'title' }, [createTextVNode('Hello')]),
                    createElementVNode('p', { key: 'content' }, [createTextVNode('World')])
                ]),
                new: createElementVNode('div', { id: 'app' }, [
                    createElementVNode('h1', { key: 'title' }, [createTextVNode('Hello')]),
                    createElementVNode('p', { key: 'content' }, [createTextVNode('Vue')])
                ])
            },
            reorder: {
                old: createElementVNode('ul', {}, [
                    createElementVNode('li', { key: '1' }, [createTextVNode('Item 1')]),
                    createElementVNode('li', { key: '2' }, [createTextVNode('Item 2')]),
                    createElementVNode('li', { key: '3' }, [createTextVNode('Item 3')])
                ]),
                new: createElementVNode('ul', {}, [
                    createElementVNode('li', { key: '3' }, [createTextVNode('Item 3')]),
                    createElementVNode('li', { key: '1' }, [createTextVNode('Item 1')]),
                    createElementVNode('li', { key: '2' }, [createTextVNode('Item 2')])
                ])
            },
            addRemove: {
                old: createElementVNode('ul', {}, [
                    createElementVNode('li', { key: '1' }, [createTextVNode('Item 1')]),
                    createElementVNode('li', { key: '2' }, [createTextVNode('Item 2')])
                ]),
                new: createElementVNode('ul', {}, [
                    createElementVNode('li', { key: '1' }, [createTextVNode('Item 1')]),
                    createElementVNode('li', { key: '3' }, [createTextVNode('Item 3')]),
                    createElementVNode('li', { key: '4' }, [createTextVNode('Item 4')])
                ])
            },
            complex: {
                old: createElementVNode('div', { id: 'app' }, [
                    createElementVNode('h1', { key: 'title' }, [createTextVNode('Todo List')]),
                    createElementVNode('ul', { key: 'list' }, [
                        createElementVNode('li', { key: '1' }, [createTextVNode('Learn Vue')]),
                        createElementVNode('li', { key: '2' }, [createTextVNode('Build App')]),
                        createElementVNode('li', { key: '3' }, [createTextVNode('Deploy')])
                    ]),
                    createElementVNode('p', { key: 'footer' }, [createTextVNode('Footer')])
                ]),
                new: createElementVNode('div', { id: 'app' }, [
                    createElementVNode('h1', { key: 'title' }, [createTextVNode('Updated Todo List')]),
                    createElementVNode('ul', { key: 'list' }, [
                        createElementVNode('li', { key: '2' }, [createTextVNode('Build App')]),
                        createElementVNode('li', { key: '4' }, [createTextVNode('Test App')]),
                        createElementVNode('li', { key: '1' }, [createTextVNode('Learn Vue')])
                    ]),
                    createElementVNode('div', { key: 'new-section' }, [createTextVNode('New Section')])
                ])
            }
        };

        function runDemo(demoName) {
            const demo = demos[demoName];
            if (!demo) return;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // æ¸²æŸ“è™šæ‹ŸDOMæ ‘
            renderVNodeTree(demo.old, document.getElementById('oldTree'));
            renderVNodeTree(demo.new, document.getElementById('newTree'));
            
            // æ‰§è¡Œdiffå¯è§†åŒ–
            visualizeDiff(demo.old, demo.new);
        }

        function clearDemo() {
            document.getElementById('oldTree').innerHTML = '';
            document.getElementById('newTree').innerHTML = '';
            document.getElementById('diffSteps').innerHTML = '';
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            
            // é‡ç½®ç»Ÿè®¡
            document.getElementById('createCount').textContent = '0';
            document.getElementById('updateCount').textContent = '0';
            document.getElementById('removeCount').textContent = '0';
            document.getElementById('moveCount').textContent = '0';
        }

        // ç®—æ³•ä»£ç åˆ‡æ¢åŠŸèƒ½
        function showAlgorithm(algorithmName) {
            // éšè—æ‰€æœ‰ä»£ç å†…å®¹
            document.querySelectorAll('.code-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„activeçŠ¶æ€
            document.querySelectorAll('.code-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„ä»£ç å†…å®¹
            const targetContent = document.getElementById(algorithmName + '-code');
            if (targetContent) {
                targetContent.style.display = 'block';
            }
            
            // æ¿€æ´»é€‰ä¸­çš„æ ‡ç­¾
            event.target.classList.add('active');
        }

        // é¡µé¢åŠ è½½å®Œæˆåè¿è¡ŒåŸºç¡€æ¼”ç¤º
        window.addEventListener('load', () => {
            runDemo('basic');
        });
    </script>
</body>
</html>
